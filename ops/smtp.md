# Създайте свой собствен SMTP сървър за изпращане на поща

## преамбюл

SMTP може директно да закупува услуги от облачни доставчици, като например:

* [Amazon SES SMTP](https://docs.aws.amazon.com/ses/latest/dg/send-email-smtp.html)
* [Ali натискане на имейл в облака](https://www.alibabacloud.com/help/directmail/latest/three-mail-sending-methods)

Можете също да създадете свой собствен пощенски сървър - неограничено изпращане, ниска обща цена.

По-долу демонстрираме стъпка по стъпка как да изградим наш собствен пощенски сървър.

## Избор на сървър

Самостоятелно хостваният SMTP сървър изисква публичен IP с отворени портове 25, 456 и 587.

Често използваните публични облаци са блокирали тези портове по подразбиране и може да е възможно да ги отворите чрез издаване на работна поръчка, но в крайна сметка това е много обезпокоително.

Препоръчвам да купувате от хост, който има отворени тези портове и поддържа настройка на обратни имена на домейни.

Тук препоръчвам [Contabo](https://contabo.com) .

Contabo е хостинг доставчик, базиран в Мюнхен, Германия, основан през 2003 г. с много конкурентни цени.

Ако изберете евро като валута на покупка, цената ще бъде по-евтина (сървър с 8 GB памет и 4 процесора струва около 529 юана на година, а първоначалната инсталационна такса е безплатна за една година).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/UoAQkwY.webp)

Когато правите поръчка, отбележете, `prefer AMD` и сървърът с AMD CPU ще има по-добра производителност.

По-долу ще взема VPS на Contabo като пример, за да демонстрирам как да изградите свой собствен пощенски сървър.

## Системна конфигурация на Ubuntu

Операционната система тук е Ubuntu 22.04

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/smpIu1F.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/m7Mwjwr.webp)

Ако сървърът на ssh показва `Welcome to TinyCore 13!` (както е показано на фигурата по-долу), това означава, че системата все още не е инсталирана. Моля, прекъснете връзката с ssh и изчакайте няколко минути, за да влезете отново.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/-qKACz9.webp)

Когато се появи `Welcome to Ubuntu 22.04.1 LTS` , инициализирането е завършено и можете да продължите със следните стъпки.

### [По избор] Инициализирайте средата за разработка

Тази стъпка не е задължителна.

За удобство поставям инсталацията и системната конфигурация на софтуера на ubuntu в [github.com/wactax/ops.os/tree/main/ubuntu](https://github.com/wactax/ops.os/tree/main/ubuntu) .

Изпълнете следната команда, за да инсталирате с едно щракване.

```
bash <(curl -s https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

Китайски потребители, моля, използвайте следната команда вместо това и езикът, часовата зона и т.н. ще бъдат зададени автоматично.

```
CN=1 bash <(curl -s https://ghproxy.com/https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

### Contabo позволява IPV6

Активирайте IPV6, така че SMTP да може също да изпраща имейли с IPV6 адреси.

редактирайте `/etc/sysctl.conf`

Променете или добавете следните редове

```
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
```

Продължете с [урока contabo: Добавяне на IPv6 свързаност към вашия сървър](https://contabo.com/blog/adding-ipv6-connectivity-to-your-server/)

Редактирайте `/etc/netplan/01-netcfg.yaml` , добавете няколко реда, както е показано на фигурата по-долу (конфигурационният файл по подразбиране на Contabo VPS вече има тези редове, просто ги разкоментирайте).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/5MEi41I.webp)

След това `netplan apply` за да влезе в сила променената конфигурация.

След като конфигурацията е успешна, можете да използвате `curl 6.ipw.cn` за да видите ipv6 адреса на вашата външна мрежа.

## Клониране на конфигурационното хранилище ops

```
git clone https://github.com/wactax/ops.soft.git
```

## Генерирайте безплатен SSL сертификат за вашето име на домейн

Изпращането на поща изисква SSL сертификат за криптиране и подписване.

Използваме [acme.sh](https://github.com/acmesh-official/acme.sh) за генериране на сертификати.

acme.sh е автоматизиран инструмент за подписване на сертификати с отворен код,

Въведете конфигурационния склад ops.soft, стартирайте `./ssl.sh` и папка `conf` ще бъде създадена в **горната директория** .

Намерете вашия DNS доставчик от [acme.sh dnsapi](https://github.com/acmesh-official/acme.sh/wiki/dnsapi) , редактирайте `conf/conf.sh` .

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Qjq1C1i.webp)

След това изпълнете `./ssl.sh 123.com` , за да генерирате `123.com` и `*.123.com` сертификати за името на вашия домейн.

Първото стартиране автоматично ще инсталира [acme.sh](https://github.com/acmesh-official/acme.sh) и ще добави планирана задача за автоматично подновяване. Можете да видите `crontab -l` , има такъв ред, както следва.

```
52 0 * * * "/mnt/www/.acme.sh"/acme.sh --cron --home "/mnt/www/.acme.sh" > /dev/null
```

Пътят за генерирания сертификат е нещо като `/mnt/www/.acme.sh/123.com_ecc。`

Подновяването на сертификат ще извика скрипта `conf/reload/123.com.sh` , редактирайте този скрипт, можете да добавите команди като `nginx -s reload` , за да опресните кеша на сертификатите на свързани приложения.

## Изградете SMTP сървър с chasquid

[chasquid](https://github.com/albertito/chasquid) е SMTP сървър с отворен код, написан на езика Go.

Като заместител на древните програми за пощенски сървъри като Postfix и Sendmail, chasquid е по-прост и по-лесен за използване, а също така е по-лесен за вторична разработка.

Изпълнете `./chasquid/init.sh 123.com` ще се инсталира автоматично с едно щракване (заменете 123.com с вашето изпращащо име на домейн).

## Конфигуриране на имейл подпис DKIM

DKIM се използва за изпращане на имейл подписи, за да се предотврати третирането на писмата като спам.

След като командата се изпълни успешно, ще бъдете подканени да зададете DKIM запис (както е показано по-долу).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/LJWGsmI.webp)

Просто добавете TXT запис към вашия DNS (както е показано по-долу).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/0szKWqV.webp)

## Преглед на състоянието и регистрационните файлове на услугата

 `systemctl status chasquid` Вижте състоянието на услугата.

Състоянието на нормална работа е както е показано на фигурата по-долу

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/CAwyY4E.webp)

 `grep chasquid /var/log/syslog` или `journalctl -xeu chasquid` може да прегледа регистъра на грешките.

## Обратна конфигурация на име на домейн

Обратното име на домейн позволява IP адресът да бъде преобразуван в съответното име на домейн.

Задаването на обратно име на домейн може да предотврати идентифицирането на имейли като спам.

Когато пощата бъде получена, получаващият сървър ще извърши обратен анализ на име на домейн на IP адреса на изпращащия сървър, за да потвърди дали изпращащият сървър има валидно обратно име на домейн.

Ако изпращащият сървър няма обратно име на домейн или ако обратното име на домейн не съвпада с IP адреса на изпращащия сървър, получаващият сървър може да разпознае имейла като спам или да го отхвърли.

Посетете [https://my.contabo.com/rdns](https://my.contabo.com/rdns) и конфигурирайте, както е показано по-долу

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/IIPdBk_.webp)

След като зададете обратното име на домейн, не забравяйте да конфигурирате разделителната способност напред на името на домейна ipv4 и ipv6 към сървъра.

## Редактирайте името на хоста на chasquid.conf

Променете `conf/chasquid/chasquid.conf` до стойността на обратното име на домейн.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/6Fw4SQi.webp)

След това изпълнете `systemctl restart chasquid` за да рестартирате услугата.

## Архивиране на conf в git хранилище

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Fier9uv.webp)

Например архивирам папката conf в моя собствен процес на github, както следва

Първо създайте частен склад

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ZSCT1t1.webp)

Влезте в директорията conf и изпратете в склада

```
git init
git add .
git commit -m "init"
git branch -M main
git remote add origin git@github.com:wac-tax-key/conf.git
git push -u origin main
```

## Добавете подател

бягам

```
chasquid-util user-add i@wac.tax
```

Може да добавя подател

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/khHjLof.webp)

### Проверете дали паролата е зададена правилно

```
chasquid-util authenticate i@wac.tax --password=xxxxxxx
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/e92JHXq.webp)

След добавяне на потребителя, `chasquid/domains/wac.tax/users` ще бъде актуализиран, не забравяйте да го изпратите в склада.

## DNS добавете SPF запис

SPF (Sender Policy Framework) е технология за проверка на имейл, използвана за предотвратяване на имейл измами.

Той проверява самоличността на изпращача на поща, като проверява дали IP адресът на подателя съвпада с DNS записите на името на домейна, за което се представя, предотвратявайки изпращането на измамници от фалшиви имейли.

Добавянето на SPF записи може да предотврати идентифицирането на имейлите като спам във възможно най-голяма степен.

Ако вашият сървър за имена на домейни не поддържа тип SPF, просто добавете запис тип TXT.

Например SPF на `wac.tax` е както следва

`v=spf1 a mx include:_spf.wac.tax include:_spf.google.com ~all`

SPF за `_spf.wac.tax`

`v=spf1 a:smtp.wac.tax ~all`

Имайте предвид, че тук имам `include:_spf.google.com` , това е така, защото по-късно ще конфигурирам `i@wac.tax` като адрес за изпращане в пощенската кутия на Google.

## DNS конфигурация DMARC

DMARC е съкращението на (Domain-based Message Authentication, Reporting & Conformance).

Използва се за улавяне на отхвърляния на SPF (може би причинени от грешки в конфигурацията или някой друг се представя за вас, за да изпрати спам).

Добавете TXT запис `_dmarc` ,

Съдържанието е следното

```
v=DMARC1; p=quarantine; fo=1; ruf=mailto:ruf@wac.tax; rua=mailto:rua@wac.tax
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/k44P7O3.webp)

Значението на всеки параметър е както следва

### p (Политика)

Показва как да се обработват имейли, които не са преминали проверката на SPF (Sender Policy Framework) или DKIM (DomainKeys Identified Mail). Параметърът p може да бъде зададен на една от трите стойности:

* няма: Не се предприемат действия, само резултатът от проверката се връща обратно на подателя чрез механизма за докладване по имейл.
* Карантина: Поставете имейла, който не е преминал проверката, в папката за нежелана поща, но няма да го отхвърлите директно.
* отказ: Директно отхвърляне на имейли, които не са преминали проверката.

### fo (Опции за отказ)

Указва количеството информация, върната от механизма за докладване. Може да бъде зададена на една от следните стойности:

* 0: Докладвайте резултатите от проверката за всички съобщения
* 1: Докладвайте само съобщения, които не са преминали проверката
* d: Докладвайте само за неуспешна проверка на име на домейн
* s: докладвайте само за грешки при проверка на SPF
* l: Докладвайте само неуспешни проверки на DKIM

### rua & ruf

* rua (URI за отчитане за обобщени отчети): Имейл адрес за получаване на обобщени отчети
* ruf (URI за докладване за съдебни доклади): имейл адрес за получаване на подробни отчети

## Добавете MX записи, за да препращате имейли към Google Mail

Тъй като не можах да намеря безплатна корпоративна пощенска кутия, която поддържа универсални адреси (Catch-All, може да получава всякакви имейли, изпратени до това име на домейн, без ограничения за префикси), използвах chasquid, за да препратя всички имейли към моята пощенска кутия в Gmail.

**Ако имате собствена платена бизнес пощенска кутия, моля, не променяйте MX и пропуснете тази стъпка.**

Редактирайте `conf/chasquid/domains/wac.tax/aliases` , задайте препращаща пощенска кутия

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/OBDl2gw.webp)

`*` показва всички имейли, `i` е префиксът на имейл адреса на изпращащия потребител, създаден по-горе. За да препраща поща, всеки потребител трябва да добави ред.

След това добавете MX записа (тук посочвам директно адреса на обратното име на домейн, както е показано на първия ред на фигурата по-долу).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/7__KrU8.webp)

След като конфигурацията приключи, можете да използвате други имейл адреси, за да изпращате имейли до `i@wac.tax` и `any123@wac.tax` , за да видите дали можете да получавате имейли в Gmail.

Ако не, проверете дневника на chasquid ( `grep chasquid /var/log/syslog` ).

## Изпратете имейл до i@wac.tax с Google Mail

След като Google Mail получи имейла, естествено се надявах да отговоря с `i@wac.tax` вместо i.wac.tax@gmail.com.

Посетете [https://mail.google.com/mail/u/1/#settings/accounts](https://mail.google.com/mail/u/1/#settings/accounts) и щракнете върху „Добавяне на друг имейл адрес“.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/PAvyE3C.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/_OgLsPT.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/XIUf6Dc.webp)

След това въведете кода за потвърждение, получен от имейла, до който е препратен.

И накрая, той може да бъде зададен като адрес на подател по подразбиране (заедно с опцията за отговор със същия адрес).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/a95dO60.webp)

По този начин завършихме създаването на SMTP пощенския сървър и в същото време използваме Google Mail за изпращане и получаване на имейли.

## Изпратете тестов имейл, за да проверите дали конфигурацията е успешна

Въведете `ops/chasquid`

Изпълнете `direnv allow` инсталиране на зависимости (direnv е инсталиран в предишния процес на инициализация с един ключ и е добавена кука към обвивката)

тогава бягай

```
user=i@wac.tax pass=xxxx to=iuser.link@gmail.com ./sendmail.coffee
```

Значението на параметрите е следното

* потребител: SMTP потребителско име
* пропуск: SMTP парола
* до: получател

Можете да изпратите тестов имейл.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ae1iWyM.webp)

Препоръчително е да използвате Gmail за получаване на тестови имейли, за да проверите дали конфигурациите са успешни.

### TLS стандартно криптиране

Както е показано на фигурата по-долу, има тази малка ключалка, което означава, че SSL сертификатът е успешно активиран.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/SrdbAwh.webp)

След това щракнете върху „Покажи оригиналния имейл“

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/qQQsdxg.webp)

### DKIM

Както е показано на фигурата по-долу, оригиналната пощенска страница на Gmail показва DKIM, което означава, че конфигурацията на DKIM е успешна.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/an6aXK6.webp)

Проверете Received в заглавката на оригиналния имейл и можете да видите, че адресът на изпращача е IPV6, което означава, че IPV6 също е конфигуриран успешно.
